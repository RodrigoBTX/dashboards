{% extends "base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block head %}

<!-- Chart.js CDN - Necessário para renderizar o gráfico -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

<style>
/* Estilos para a grelha */
.fixed-height-grid {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
}

.fixed-height-grid table {
    margin-bottom: 0;
    width: 100%;
}

.fixed-height-grid thead th {
    position: sticky;
    top: 0;
    background-color: #343a3d;
    color: white;
    z-index: 10;
    box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.4);
    padding: 0.75rem;
}
</style>

{% endblock head %}

{% block content %}

<div class="container-fluid py-4">
<h1 class="mb-4 text-primary"><i class="fas fa-file-invoice-dollar me-2"></i> {{ page_title }}</h1>
<p class="text-muted">Detalhe dos registos e análise gráfica por cliente.</p>

<!-- INJEÇÃO DE DADOS JSON VIA ATRIBUTOS DATA-JSON (MÉTODO MAIS SEGURO) -->
<div id="grid-data-payload" data-json="{{ grid_data | tojson | safe }}" style="display:none;"></div>
<div id="chart-data-payload" data-json="{{ chart_data | tojson | safe }}" style="display:none;"></div>
<!-- FIM DA INJEÇÃO DE DADOS -->

<div class="row g-4 mt-4">
    
    <!-- GRÁFICO (Chart.js) -->
    <!-- Coluna 5 para o Gráfico -->
    <div class="col-lg-5">
        <div class="card shadow border-0 rounded-4 h-100">
            <div class="card-header bg-white">
                <h5 class="mb-0 text-dark">Distribuição por Cliente</h5>
            </div>
            <div class="card-body d-flex align-items-center justify-content-center">
                <canvas id="clientChart" style="max-height: 400px;"></canvas>
                <div id="chartNoDataMessage" class="alert alert-warning text-center" style="display: none;">
                    Dados insuficientes para gerar o gráfico.
                </div>
            </div>
        </div>
    </div>
    
    <!-- GRELHA DE DADOS -->
    <!-- Coluna 7 para a Tabela -->
    <div class="col-lg-7">
        <div class="card shadow border-0 rounded-4 h-100" id="dynamicGrid">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 id="gridTitle" class="mb-0 text-dark">Registos de {{ page_title }}</h5>
            </div>
            <div class="card-body p-0">
                <div id="dataTableContainer" class="table-responsive fixed-height-grid">
                    <table class="table table-striped table-hover align-middle table-sm">
                        <thead id="dataTableHead">
                            <!-- Cabeçalhos inseridos por JS -->
                        </thead>
                        <tbody id="dataTableBody">
                            <tr>
                                <td colspan="10" class="text-center text-muted">A carregar dados...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="noDataMessage" class="alert alert-warning text-center m-3" style="display: none;">
                    Nenhum registo detalhado encontrado.
                </div>
            </div>
        </div>
    </div>
</div>

</div>
{% endblock %}

{% block scripts %}

<script>
// Variáveis Globais (Inicialmente vazias, preenchidas dentro de initializePage)
let GRID_DATA = [];
let CHART_DATA = [];
let clientChartInstance = null; // Variável global para a instância do gráfico


// ----------------------------------------------------------------------
// FUNÇÕES DE RENDERIZAÇÃO
// ----------------------------------------------------------------------

function updateDataTable(newData) {
    const tableBody = document.getElementById('dataTableBody');
    const tableHead = document.getElementById('dataTableHead');
    const noDataMessage = document.getElementById('noDataMessage');

    if (!tableBody || !tableHead) return;

    tableBody.innerHTML = '';
    tableHead.innerHTML = '';
    if (noDataMessage) noDataMessage.style.display = 'none';

    if (newData && newData.length > 0) {
        // Assume que as chaves do dicionário são os cabeçalhos
        const headers = Object.keys(newData[0]);
        
        // Recria Cabeçalhos
        const headerRow = document.createElement('tr');
        headers.forEach(key => {
            const th = document.createElement('th');
            // Formata o nome da coluna para ser mais amigável
            th.textContent = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()); 
            headerRow.appendChild(th);
        });
        tableHead.appendChild(headerRow);

        // Preenche o corpo da tabela
        newData.forEach(rowData => {
            const tr = document.createElement('tr');
            headers.forEach(key => {
                const td = document.createElement('td');
                td.textContent = rowData[key] ?? "-";
                // ADICIONE AQUI LÓGICA DE DETALHE SE NECESSÁRIO
                tr.appendChild(td);
            });
            tableBody.appendChild(tr);
        });
        console.log("==> Tabela: Tabela detalhada atualizada com sucesso.");
    } else {
        if (noDataMessage) noDataMessage.style.display = 'block';
        tableBody.innerHTML = `<tr><td colspan="10" class="text-center text-muted">Nenhum registo encontrado.</td></tr>`;
        console.log("==> Tabela: Nenhum dado detalhado recebido.");
    }
}

function updateChart(chartData) {
    const chartCanvas = document.getElementById('clientChart');
    const chartNoDataMessage = document.getElementById('chartNoDataMessage');

    if (!chartCanvas) return;

    // Destrói a instância anterior se existir
    if (clientChartInstance) {
        clientChartInstance.destroy();
    }

    if (!chartData || chartData.length === 0) {
        chartNoDataMessage.style.display = 'block';
        chartCanvas.style.display = 'none';
        console.log("==> Gráfico: Nenhum dado de gráfico recebido.");
        return;
    }

    // O Chart.js espera dados num formato específico.
    // Assumimos que a query retorna um formato como: [{"Cliente": "A", "Nº Encomendas": 10}, ...]
    const labels = chartData.map(item => item.Cliente);
    const dataValues = chartData.map(item => item["Nº Encomendas"]);

    chartNoDataMessage.style.display = 'none';
    chartCanvas.style.display = 'block';

    clientChartInstance = new Chart(chartCanvas, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                label: 'Total de Encomendas',
                data: dataValues,
                backgroundColor: [
                    '#3498db', '#e74c3c', '#2ecc71', '#f1c40f', '#9b59b6', 
                    '#34495e', '#1abc9c', '#e67e22', '#7f8c8d', '#d35400'
                ],
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                },
                title: {
                    display: true,
                    text: 'Volume de Encomendas por Cliente (Top 10)'
                }
            }
        }
    });
    console.log("==> Gráfico: Chart.js renderizado com sucesso.");

}


// ----------------------------------------------------------------------
// LÓGICA DE INICIALIZAÇÃO SÍNCRONA E EXTRAÇÃO DE DADOS
// ----------------------------------------------------------------------

function initializePage() {
    try {
        console.log("==> SCRIPT STARTED. DOM carregado. A carregar dados de atributos HTML...");

        // 1. Recuperar JSON string dos atributos de dados ocultos
        const gridDataElement = document.getElementById('grid-data-payload');
        const chartDataElement = document.getElementById('chart-data-payload');

        if (!gridDataElement || !chartDataElement) {
            console.error("ERRO FATAL: Elementos de payload de dados (grid-data-payload ou chart-data-payload) não encontrados no DOM.");
            return;
        }

        const gridJsonString = gridDataElement.getAttribute('data-json');
        const chartJsonString = chartDataElement.getAttribute('data-json');

        // 2. Tentar analisar a string JSON
        // Se a string for 'null' ou vazia (em caso de falha de query), usamos '[]' para evitar quebra.
        GRID_DATA = JSON.parse(gridJsonString && gridJsonString !== 'null' ? gridJsonString : '[]'); 
        CHART_DATA = JSON.parse(chartJsonString && chartJsonString !== 'null' ? chartJsonString : '[]');
        
        console.log("==> DADOS RECEBIDOS E ANALISADOS COM SUCESSO:");
        console.log("GRID_DATA (Tabela):", GRID_DATA);
        console.log("CHART_DATA (Gráfico):", CHART_DATA);

        // 3. Renderizar
        console.log("==> INICIALIZAÇÃO: A carregar dados síncronos.");
        updateDataTable(GRID_DATA);
        updateChart(CHART_DATA);

    } catch (e) {
        console.error("ERRO CRÍTICO DURANTE A INICIALIZAÇÃO OU ANÁLISE DO JSON.", e);
        // Tenta mostrar o início da string JSON que falhou, se disponível
        if (typeof gridJsonString !== 'undefined') {
            const clipped = gridJsonString.length > 500 ? gridJsonString.substring(0, 500) + "..." : gridJsonString;
            console.error("STRING JSON DA GRELHA (PODE ESTAR QUEBRADA):", clipped); 
        }
        // Atualiza a tabela com a mensagem de erro
        const tableBody = document.getElementById('dataTableBody');
        if(tableBody) {
             tableBody.innerHTML = `<tr><td colspan="10" class="text-center text-danger fw-bold">Erro ao carregar os dados. Verifique a consola para mais detalhes.</td></tr>`;
        }
    }
}

// Dispara a inicialização assim que o DOM estiver pronto
document.addEventListener('DOMContentLoaded', initializePage);
</script>

{% endblock scripts %}